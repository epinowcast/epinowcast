% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/structural-conversion.R
\name{.convert_structural_to_arrays}
\alias{.convert_structural_to_arrays}
\title{Convert nested structural list to arrays for Stan}
\usage{
.convert_structural_to_arrays(structural, n_groups, n_times, max_delay)
}
\arguments{
\item{structural}{A nested list structure: list(groups) of list(times) of
matrices (max_delay x max_delay). Each matrix contains 0s and 1s
indicating which delays aggregate to which reporting delays.}

\item{n_groups}{Integer number of groups.}

\item{n_times}{Integer number of time points.}

\item{max_delay}{Integer maximum delay.}
}
\value{
A list with three components:
\itemize{
\item \code{indicators}: 4D array \link{groups, times, max_delay, max_delay} of
aggregation indicator matrices
\item \code{n_selected}: 3D array \link{groups, times, max_delay} containing the
number of selected indices per row
\item \code{selected_idx}: 4D array \link{groups, times, max_delay, max_delay}
containing the column indices where each row has 1s
}
}
\description{
Converts a nested list structure of aggregation indicator matrices into
the array format required by Stan, preserving matrix structure. Also
precomputes indices for numerically stable log_sum_exp operations.
}
\details{
This function carefully preserves the matrix structure during conversion
to avoid the scrambling that occurs with naive \code{array(unlist())} usage.
The nested loop explicitly assigns each matrix to the correct position
in the 4D array.

The precomputed indices enable Stan to use \code{log_sum_exp()} for numerical
stability instead of \code{log(matrix * exp(vector))} which can create
gradient singularities.
}
\keyword{internal}
