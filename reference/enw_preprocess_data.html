<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Preprocess observations — enw_preprocess_data • epinowcast</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Preprocess observations — enw_preprocess_data"><meta property="og:description" content="This function preprocesses raw observations under the
assumption they are reported as cumulative counts by a reference and
report date and is used to assign groups. It also constructs data objects
used by visualisation and modelling functions including the
observed empirical probability of a report on a given day, the cumulative
probability of report, the latest available observations, incidence of
observations, and metadata about the date of reference and report (used to
construct models). This function wraps other preprocessing functions that may
be instead used individually if required. Note that internally reports
beyond the user specified delay are dropped for modelling purposes with the
cum_prop_reported and max_confirm variables allowing the user to check
the impact this may have (if cum_prop_reported is significantly below 1 a
longer max_delay may be appropriate). Also note that if missing reference
or report dates are suspected to occur in your data then these need to be
completed with enw_complete_dates()."><meta property="og:image" content="https://package.epinowcast.org/reference/figures/README-nowcast-1.png"><meta property="og:image:alt" content="An R package for flexible hierarchical nowcasting"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@seabbs"><meta name="twitter:site" content="@seabbs"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epinowcast</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/epinowcast.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li class="divider">
    <li class="dropdown-header">Model details</li>
    <li>
      <a href="../articles/model.html">Model definition and implementation</a>
    </li>
    <li>
      <a href="../articles/distributions.html">Discretised distributions</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Case studies</li>
    <li>
      <a href="../articles/germany-age-stratified-nowcasting.html">Hierarchical nowcasting of age stratified COVID-19 hospitalisations in Germany</a>
    </li>
    <li>
      <a href="../articles/single-timeseries-rt-estimation.html">Estimating the effective reproduction number in real-time for a single timeseries with reporting delays</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Working with epinowcast</li>
    <li>
      <a href="../articles/stan-help.html">Resources to help with model fitting using Stan</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/epinowcast/epinowcast/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Preprocess observations</h1>
    <small class="dont-index">Source: <a href="https://github.com/epinowcast/epinowcast/blob/HEAD/R/preprocess.R" class="external-link"><code>R/preprocess.R</code></a></small>
    <div class="hidden name"><code>enw_preprocess_data.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function preprocesses raw observations under the
assumption they are reported as cumulative counts by a reference and
report date and is used to assign groups. It also constructs data objects
used by visualisation and modelling functions including the
observed empirical probability of a report on a given day, the cumulative
probability of report, the latest available observations, incidence of
observations, and metadata about the date of reference and report (used to
construct models). This function wraps other preprocessing functions that may
be instead used individually if required. Note that internally reports
beyond the user specified delay are dropped for modelling purposes with the
<code>cum_prop_reported</code> and <code>max_confirm</code> variables allowing the user to check
the impact this may have (if <code>cum_prop_reported</code> is significantly below 1 a
longer <code>max_delay</code> may be appropriate). Also note that if missing reference
or report dates are suspected to occur in your data then these need to be
completed with <code><a href="enw_complete_dates.html">enw_complete_dates()</a></code>.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">enw_preprocess_data</span><span class="op">(</span></span>
<span>  <span class="va">obs</span>,</span>
<span>  by <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">max_delay</span>,</span>
<span>  timestep <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  set_negatives_to_zero <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  copy <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>obs</dt>
<dd><p>A <code>data.frame</code> containing at least the following variables:
<code>reference_date</code> (index date of interest), <code>report_date</code> (report date for
observations), <code>confirm</code> (cumulative observations by reference and report
date).</p></dd>


<dt>by</dt>
<dd><p>A character vector describing the stratification of
observations. This defaults to no grouping. This should be used
when modelling multiple time series in order to identify them for
downstream modelling</p></dd>


<dt>max_delay</dt>
<dd><p>The maximum number of days to model in the delay
distribution. If not specified the maximum observed delay is assumed to be
the true maximum delay in the model. Otherwise, an integer greater than or
equal to 1 can be specified. Observations with delays larger then the maximum
delay will be dropped. If the specified maximum delay is too short, nowcasts
can be biased as important parts of the true delay distribution are cut off.
At the same time, computational cost scales non-linearly with this setting,
so you want the maximum delay to be as long as necessary, but not much
longer.</p>
<p>Steps to take to determine the maximum delay:</p><ul><li><p>Consider what is realistic and relevant for your application.</p></li>
<li><p>Check the proportion of observations reported (<code>prop_reported</code>)
by delay in the <code>new_confirm</code> output of <code>enw_preprocess_obs</code>.</p></li>
<li><p>Use <code><a href="check_max_delay.html">check_max_delay()</a></code> to check the coverage of a candidate <code>max_delay</code>.</p></li>
<li><p>If in doubt, check if increasing the maximum delay noticeably changes the
delay distribution or nowcasts as estimated by <code>epinowcast</code>. If it does,
your maximum delay may still be too short.</p></li>
</ul><p>Note that delays are zero indexed and so include the reference date and
<code>max_delay - 1</code> other days (i.e. a <code>max_delay</code> of 1 corresponds to
no delay).</p></dd>


<dt>timestep</dt>
<dd><p>The timestep to used in the process model (i.e. the
reference date model). This can be a string ("day", "week", "month") or a
numeric whole number representing the number of days. If your data does not
have this timestep then you may wish to make use of
<code><a href="enw_aggregate_cumulative.html">enw_aggregate_cumulative()</a></code> to aggregate your data to the desired timestep.</p></dd>


<dt>set_negatives_to_zero</dt>
<dd><p>Logical, defaults to TRUE. Should negative
counts (for calculated incidence of observations) be set to zero? Currently
downstream modelling does not support negative counts and so setting must be
TRUE if intending to use <code><a href="epinowcast.html">epinowcast()</a></code>.</p></dd>


<dt>...</dt>
<dd><p>Other arguments to <code><a href="enw_add_metaobs_features.html">enw_add_metaobs_features()</a></code>,
e.g. <code>holidays</code>, which sets commonly used metadata
(e.g. day of week, days since start of time series)</p></dd>


<dt>copy</dt>
<dd><p>A logical; if <code>TRUE</code> (the default) creates a copy; otherwise,
modifies <code>obs</code> in place.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>A data.table containing processed observations as a series of nested
data.frames as well as variables containing metadata. These are:</p><ul><li><p><code>obs</code>: (observations with the addition of empirical reporting proportions
and restricted to the specified maximum delay).</p></li>
<li><p><code>new_confirm</code>: Incidence of notifications by reference and report date.
Empirical reporting distributions are also added.</p></li>
<li><p><code>latest</code>: The latest available observations.</p></li>
<li><p><code>missing_reference</code>: Observations missing reference dates.</p></li>
<li><p><code>reporting_triangle</code>: Incident observations by report and reference date in
the standard reporting triangle matrix format.</p></li>
<li><p><code>metareference</code>: Metadata reference dates derived from observations.</p></li>
<li><p><code>metrareport</code>: Metadata for report dates.</p></li>
<li><p><code>metadelay</code>: Metadata for reporting delays produced using
<code><a href="enw_metadata_delay.html">enw_metadata_delay()</a></code>.</p></li>
<li><p><code>max_delay</code>: Maximum delay to be modelled by epinowcast.</p></li>
<li><p><code>time</code>: Numeric, number of timepoints in the data.</p></li>
<li><p><code>snapshots</code>: Numeric, number of available data snapshots to use for
nowcasting.</p></li>
<li><p><code>groups</code>: Numeric, Number of groups/strata in the supplied observations
(set using <code>by</code>).</p></li>
<li><p><code>max_date</code>: The maximum available report date.</p></li>
</ul></div>
    <div id="details">
    <h2>Details</h2>
    <p>If <code>max_delay</code> is numeric, it will be internally coerced to integer
using <code><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer()</a></code>).</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>Preprocessing functions
<code><a href="enw_add_delay.html">enw_add_delay</a>()</code>,
<code><a href="enw_add_max_reported.html">enw_add_max_reported</a>()</code>,
<code><a href="enw_add_metaobs_features.html">enw_add_metaobs_features</a>()</code>,
<code><a href="enw_assign_group.html">enw_assign_group</a>()</code>,
<code><a href="enw_complete_dates.html">enw_complete_dates</a>()</code>,
<code><a href="enw_construct_data.html">enw_construct_data</a>()</code>,
<code><a href="enw_extend_date.html">enw_extend_date</a>()</code>,
<code><a href="enw_filter_delay.html">enw_filter_delay</a>()</code>,
<code><a href="enw_filter_reference_dates.html">enw_filter_reference_dates</a>()</code>,
<code><a href="enw_filter_report_dates.html">enw_filter_report_dates</a>()</code>,
<code><a href="enw_flag_observed_observations.html">enw_flag_observed_observations</a>()</code>,
<code><a href="enw_impute_na_observations.html">enw_impute_na_observations</a>()</code>,
<code><a href="enw_latest_data.html">enw_latest_data</a>()</code>,
<code><a href="enw_metadata_delay.html">enw_metadata_delay</a>()</code>,
<code><a href="enw_metadata.html">enw_metadata</a>()</code>,
<code><a href="enw_missing_reference.html">enw_missing_reference</a>()</code>,
<code><a href="enw_reporting_triangle_to_long.html">enw_reporting_triangle_to_long</a>()</code>,
<code><a href="enw_reporting_triangle.html">enw_reporting_triangle</a>()</code></p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Filter example hospitalisation data to be national and over all ages</span></span></span>
<span class="r-in"><span><span class="va">nat_germany_hosp</span> <span class="op">&lt;-</span> <span class="va">germany_covid19_hosp</span><span class="op">[</span><span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">nat_germany_hosp</span> <span class="op">&lt;-</span> <span class="va">nat_germany_hosp</span><span class="op">[</span><span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Preprocess with default settings</span></span></span>
<span class="r-in"><span><span class="va">pobs</span> <span class="op">&lt;-</span> <span class="fu">enw_preprocess_data</span><span class="op">(</span><span class="va">nat_germany_hosp</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Using the maximum observed delay of 82 days. You may want to specify a shorter</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> (or, in special cases, longer) maximum delay via the `max_delay` argument. See</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> help(enw_preprocess_data) (`?epinowcast::enw_preprocess_data()`) for details.</span>
<span class="r-in"><span><span class="va">pobs</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                      obs            new_confirm               latest</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   &lt;list&gt;                 &lt;list&gt;               &lt;list&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: &lt;data.table[12915x9]&gt; &lt;data.table[12915x11]&gt; &lt;data.table[198x10]&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    missing_reference   reporting_triangle       metareference</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               &lt;list&gt;               &lt;list&gt;              &lt;list&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: &lt;data.table[0x6]&gt; &lt;data.table[198x84]&gt; &lt;data.table[198x9]&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              metareport          metadelay max_delay  time snapshots     by</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  &lt;list&gt;             &lt;list&gt;     &lt;num&gt; &lt;int&gt;     &lt;int&gt; &lt;list&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: &lt;data.table[279x12]&gt; &lt;data.table[82x5]&gt;        82   198       198       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    groups   max_date timestep</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     &lt;int&gt;     &lt;IDat&gt;   &lt;char&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:      1 2021-10-20      day</span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by <a href="https://www.samabbott.co.uk/" class="external-link">Sam Abbott</a>, Adrian Lison, Sebastian Funk, Carl Pearson, Hugo Gruson, Felix Guenther, Michael DeWitt.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.9000.</p>
</div>

      </footer></div>

  


  

  </body></html>

