<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Resources to help with model fitting using Stan • epinowcast</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Resources to help with model fitting using Stan">
<meta name="description" content="How to address issues you may encounter with Stan">
<meta property="og:description" content="How to address issues you may encounter with Stan">
<meta property="og:image" content="https://package.epinowcast.org/reference/figures/README-nowcast-1.png">
<meta property="og:image:alt" content="An R package for flexible hierarchical nowcasting">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@seabbs">
<meta name="twitter:site" content="@seabbs">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epinowcast</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.3.0.1000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epinowcast.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Model details</h6></li>
    <li><a class="dropdown-item" href="../articles/model.html">Model definition and implementation</a></li>
    <li><a class="dropdown-item" href="../articles/distributions.html">Discretised distributions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Case studies</h6></li>
    <li><a class="dropdown-item" href="../articles/germany-age-stratified-nowcasting.html">Hierarchical nowcasting of age stratified COVID-19 hospitalisations in Germany</a></li>
    <li><a class="dropdown-item" href="../articles/single-timeseries-rt-estimation.html">Estimating the effective reproduction number in real-time for a single timeseries with reporting delays</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Working with epinowcast</h6></li>
    <li><a class="dropdown-item" href="../articles/stan-help.html">Resources to help with model fitting using Stan</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Package use cases</h6></li>
    <li><a class="dropdown-item" href="../articles/package-use-cases.html">Case studies</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epinowcast/epinowcast/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Resources to help with model fitting using Stan</h1>
                        <h4 data-toc-skip class="author">Epinowcast Team</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epinowcast/epinowcast/blob/main/vignettes/stan-help.Rmd" class="external-link"><code>vignettes/stan-help.Rmd</code></a></small>
      <div class="d-none name"><code>stan-help.Rmd</code></div>
    </div>

    
    
<div class="alert alert-warning">
<p>Before we start, it is important to know that Bayesian modelling can be complex and most, if not all, practitioners (including the authors of <a href="https://package.epinowcast.org">epinowcast</a>) are still learning on the job. Having problems that you may need to work through is part of the process. Part of the aim of the <a href="https://package.epinowcast.org">epinowcast</a> community is to lower the barriers to entry for this type of modelling in real-time infectious disease analysis so we really appreciate any input into how to make our documentation easier to use.</p>
</div>
<div class="section level2">
<h2 id="epinowcast-and-stan">Epinowcast and Stan<a class="anchor" aria-label="anchor" href="#epinowcast-and-stan"></a>
</h2>
<p><a href="https://mc-stan.org/" class="external-link">Stan</a> is the probabilistic programming language and statistical platform for statistical modelling that powers the Bayesian inference in <a href="https://package.epinowcast.org">epinowcast</a>.
The statistical models used in <a href="https://package.epinowcast.org">epinowcast</a> are primarily written in the <a href="https://mc-stan.org/docs/reference-manual/index.html" class="external-link">Stan programming language</a>, a statically typed programming language with syntax similar to C/C++.
<a href="https://package.epinowcast.org">epinowcast</a> utilises the <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>{cmdstanr}</code></a> package to interface with CmdStan, the program which executes the models written in the Stan programming language.
It is important to understand that CmdStan is a program that is <strong>distinct</strong> from but interfaced through R.
R calling a separate program to execute calculations is similar to <a href="https://cran.r-project.org/web/packages/rjags/" class="external-link"><code>{rjags}</code></a> which relies on the <a href="https://cran.r-project.org/web/packages/rjags/INSTALL" class="external-link">JAGS library</a> and <a href="https://www.r-inla.org/what-is-inla" class="external-link">R-INLA</a>.
As described in the <a href="https://package.epinowcast.org">epinowcast</a> project <a href="./index.html">README</a>, you will need to install <a href="https://mc-stan.org/cmdstanr/" class="external-link"><code>{cmdstanr}</code></a> an R package which also has the ability to install CmdStan using an R interface.
Additionally, you will need to make sure that the software required by CmdStan is installed and configured on your machine.</p>
<div class="section level3">
<h3 id="ensuring-you-have-the-proper-toolchain">Ensuring you have the proper toolchain<a class="anchor" aria-label="anchor" href="#ensuring-you-have-the-proper-toolchain"></a>
</h3>
<p>The Stan code that is written in the <a href="https://package.epinowcast.org">epinowcast</a> package is converted<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The Stan code is first passed to a Stan-specific compiled written in Ocaml called &lt;a href="https://github.com/stan-dev/stanc3" class="external-link"&gt;stanc3&lt;/a&gt;.
The optimised C++ code generated from this first step is then passed to the C++ compiler.&lt;/p&gt;'><sup>1</sup></a> to optimised C++ code and then compiled to machine-readable instructions.
Because Stan needs several programs to execute this compilation process such as the build tool <a href="https://en.wikipedia.org/wiki/Make_(software)" class="external-link">make</a> and a C++ compiler, you will need to ensure that your system has the appropriate supporting software, known as a toolchain.
The steps to install this additional software are in addition to R and are <strong>platform specific</strong>.
As a reminder, these installation steps occur <strong>outside of R</strong>.
The Stan team has assembled very detailed instructions for each platform:</p>
<ul>
<li><a href="https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html#windows" class="external-link"><strong>Windows</strong></a></li>
<li><a href="https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html#macos" class="external-link"><strong>MacOS</strong></a></li>
<li><a href="https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html#linux" class="external-link"><strong>Linux</strong></a></li>
</ul>
<p>After completing your platform-specific toolchain installation, you can move on to R.</p>
</div>
<div class="section level3">
<h3 id="now-install-cmdstanr-and-cmdstan">Now install CmdStanR and CmdStan<a class="anchor" aria-label="anchor" href="#now-install-cmdstanr-and-cmdstan"></a>
</h3>
<p>Now you can open a session of R using your favourite IDE like Rstudio or Vscode.
You’ll need to install the CmdStanR package, the R package which allows you to interface with CmdStan through R code.
There is a <a href="https://mc-stan.org/cmdstanr/articles/cmdstanr.html" class="external-link">very detailed installation guide available for CmdStanR</a> which provides the authoritative installation instructions.</p>
<p>The <a href="https://mc-stan.org/cmdstanr/" class="external-link">cmdstanr</a> package is installed as a dependency when you install <code>epinowcast</code>.
To ensure that your toolchain installation occurred successfully, run the following code in your R terminal:</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/cmdstanr/" class="external-link">cmdstanr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">check_cmdstan_toolchain</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details><p>This function will report back if the toolchain is available and set up as follows:</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#&gt; The C++ toolchain required for CmdStan is set up properly!</span></span></code></pre></div>
</details><p>If you do not get this message, return to <a href="#toolchain">the installation instructions</a> and ensure that all steps were followed.</p>
<p>Assuming you have the toolchain installed, you can install CmdStanR.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">install_cmdstan</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
</div>
<div class="section level2">
<h2 id="epinowcast-modelling">Epinowcast modelling<a class="anchor" aria-label="anchor" href="#epinowcast-modelling"></a>
</h2>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>As described in the project <code>README</code>, you can install the <code>"{epinowcast}"</code> package within R.</p>
</div>
<div class="section level3">
<h3 id="running-your-first-model">Running your first model<a class="anchor" aria-label="anchor" href="#running-your-first-model"></a>
</h3>
<p>As a reminder, in each session, each time you run a model, Stan will compile your model code.
The first time you run this model it will take a moment for the compilation to occur.</p>
</div>
<div class="section level3">
<h3 id="setting-enw_fit_opts">Setting <code>enw_fit_opts</code><a class="anchor" aria-label="anchor" href="#setting-enw_fit_opts"></a>
</h3>
<p>The <code>enw_fit_opts</code> allows you to set several critical components for the Stan computational engine.
These parameters are passed to Stan during the model fitting process and influence the computation time and quality of the model fit.
These options are inference engine agnostic and will be parsed depending on the sampler you choose (e.g., <code><a href="../reference/enw_sample.html">epinowcast::enw_sample</a></code> for full Bayesian inference).
Knowing when and if the defaults need to be changed is an important part of the Bayesian workflow.<span class="citation"><sup>[1]</sup></span>
All of the parameters are passed to the <code>sampling</code> function available from <a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link"><code>{cmdstanr}</code></a> when used with the default approach of <code><a href="../reference/enw_sample.html">epinowcast::enw_sample</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="investigating-the-quality-of-the-model-fit">Investigating the quality of the model fit<a class="anchor" aria-label="anchor" href="#investigating-the-quality-of-the-model-fit"></a>
</h2>
<p>In this section we will discuss the most common approaches when working with <a href="https://package.epinowcast.org">epinowcast</a> specifically and CmdStan/ Bayesian inference more generally.
A major component of Bayesian inference and a key component of the Bayesian workflow is validating the quality of the model fit.
As a consequence, the Bayesian workflow utilises tools that make issues of fit very apparent.<span class="citation"><sup>[1]</sup></span>
Additionally, <a href="https://package.epinowcast.org">epinowcast</a> provides supplemental information to complement the existing Stan messages to help you spot and diagnose potential model fitting issues.
The solutions to these issues typically require you to investigate your <a href="#samplerParams">sampler settings</a>, <a href="#modelParams">model settings</a>, or <a href="#modelData">interrogate your data</a> further.
It is also important to examine your posterior predictive</p>
<div class="section level3">
<h3 id="sampler-settings">Sampler settings<a class="anchor" aria-label="anchor" href="#sampler-settings"></a>
</h3>
<p><a href="https://package.epinowcast.org">epinowcast</a> provides users the ability to pass arguments directly to CmdStan which can improve model run time and produce better inferences.
These parameters can be passed the <code>enw_fit_opts</code> function.</p>
<div class="section level4">
<h4 id="chains">
<code>chains</code><a class="anchor" aria-label="anchor" href="#chains"></a>
</h4>
<p>One of the key components of Bayesian inference is creating draws from independent Markov chains (See <a href="https://betanalpha.github.io/assets/case_studies/markov_chain_monte_carlo.html#2_markov_chain_of_command" class="external-link">this post</a> by Michael Betancourt for a more detailed introduction).
To assess convergence and the reliability of a given posterior distribution at least two chains must be used with <strong><code>4</code> chains</strong> being the more common default.</p>
</div>
<div class="section level4">
<h4 id="threads_per_chain">
<code>threads_per_chain</code><a class="anchor" aria-label="anchor" href="#threads_per_chain"></a>
</h4>
<p>Stan allows for multi-threading and the Stan code used within <a href="https://package.epinowcast.org">epinowcast</a> has tried to take advantage of these capabilities where possible.
Multi-threading allows for the calculations to be spread across multiple threads, which could accelerate inference by allowing embarrassingly parallel calculations to be spread across threads and then later combined.
If possible, a good default is <code>2</code>, however, if you have available compute on your machine, you can increase this to a higher value and may see some fit time reductions.
Please note that the <code>theads_per_chain</code> has no impact on model convergence or fittings and is purely a means of speeding up the model fitting time.</p>
<div class="alert alert-warning">
<p><strong>The product of the <code>thread_per_chain</code> and <code>chains</code></strong> arguments should be equal to or less than the number of cores on your machine!</p>
</div>
</div>
<div class="section level4">
<h4 id="iter_warmup-and-iter_sampling">iter_warmup and iter_sampling<a class="anchor" aria-label="anchor" href="#iter_warmup-and-iter_sampling"></a>
</h4>
<p>The number of samples used for the warmup phase of Stan and the number of sampling iterations are controlled by the <code>iter_warmup</code> and <code>iter_sampling</code> arguments, respectively.
Stan requires a sufficient number of warmup iterations to dynamically estimate the step change sizes during model fitting.
Unlike with Gibbs sampling (such as the method used in JAGS), you generally do not need to set large values for <code>iter_warmup</code> or <code>iter_sampling</code>, but this can vary based on the <a href="https://discourse.mc-stan.org/t/number-of-iterations/1674/3" class="external-link">match between your data and your model</a>.
Conversely, setting large values for iterations could be a sign of poor model fit and indicates that other approaches need to be employed (e.g., <code>priors</code>, <code>adapt_delta</code>, <code>max_treedepth</code>).
A <a href="https://mc-stan.org/rstan/reference/Rhat.html#:~:text=Both%20bulk%2DESS%20and%20tail,respective%20posterior%20quantiles%20are%20reliable" class="external-link">general heuristic</a> is to have your bulk and tail effective sample sizes (ESS) greater than 100.
However, <a href="https://discourse.mc-stan.org/t/number-of-iterations/1674/13" class="external-link">depending on the complexity of your problem</a> increasing the number of iterations can be appropriate (i.e., your <a href="https://arxiv.org/pdf/1903.08008.pdf" class="external-link"><span class="math inline">\(\hat{R}\)</span> values are near 1</a>, <a href="https://mc-stan.org/docs/cmdstan-guide/stansummary.html" class="external-link">your Monte Carlo Standard errors</a> are low) especially if you want to make inferences regarding tail behaviours.
During the initial model fitting process, you may want to start with a lower number for <code>iter_warmup</code> such as 500 iterations per chain and increase to 750-1000 per chain (or more) if needed.
Starting with slightly short warm-ups can speed up model development timelines.
Typically we have found that 1000-2000 samples per chain for <code>iter_sampling</code> are good starting values for initial model fitting.</p>
</div>
<div class="section level4">
<h4 id="max_treedepth">max_treedepth<a class="anchor" aria-label="anchor" href="#max_treedepth"></a>
</h4>
<p>This value controls the maximum size of the trajectory taken by the sample (in power of 2) for each step.
If this value is too low, the sampler may terminate too early causing excess runtimes.
While this does not necessarily indicate model fit issues, it does represent a runtime performance opportunity (i.e., more efficient sampling).
You can increase the <code>max_treedepth</code> to an integer value greater than <code>10</code> up to <code>15</code> (or lower).
For the models used in <a href="https://package.epinowcast.org">epinowcast</a> it is common to have the <code>max_treedepth</code> set between 12 and 15.</p>
</div>
<div class="section level4">
<h4 id="adapt_delta">adapt_delta<a class="anchor" aria-label="anchor" href="#adapt_delta"></a>
</h4>
<p>This parameter sets the target average proposal acceptance probability during NUTS sampling (and is a real number value between 0 and 1).
Higher values of <code>adapt_delta</code> will result in smaller step sizes during sampling which will slow the model fitting time but can help to address <em>divergent transitions.</em>
The default value is 0.8, but this will likely need to be set slightly higher like 0.9 to 0.99 given the complexity of the models being fit.</p>
</div>
<div class="section level4">
<h4 id="some-decent-defaults">Some decent defaults<a class="anchor" aria-label="anchor" href="#some-decent-defaults"></a>
</h4>
<p>For a computer with 8 cores, a reasonable configuration would be the following:</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/enw_fit_opts.html">enw_fit_opts</a></span><span class="op">(</span></span>
<span>    save_warmup <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    pp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    threads_per_chain <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    adapt_delta <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>    max_treedepth <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>    iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    show_messages <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><div class="alert alert-warning">
<p>For very simple models <code>threads_per_chain = 1</code> may lead to models fitting faster even if more cores are available due to the overhead from within chain multi-threading. This may also be the case for models with very complex generative processes (i.e. models that use complex <span class="math inline">\(R_t\)</span> formulas). We suggest you explore what works best for your data and models.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="model-settings">Model settings<a class="anchor" aria-label="anchor" href="#model-settings"></a>
</h3>
<div class="section level4">
<h4 id="setting-priors">Setting priors<a class="anchor" aria-label="anchor" href="#setting-priors"></a>
</h4>
<p>Setting sensible priors is important for Bayesian inference.
When pre-processing your data, you can retrieve the prior arguments using the <code>enw_reference</code> function.
As shown below, you can retrieve your current files and manipulate them as needed.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">default_priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enw_reference.html">enw_reference</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="../reference/enw_example.html">enw_example</a></span><span class="op">(</span><span class="st">"preprocessed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">default_priors</span></span></code></pre></div>
</details><p>In the above example, if you have some reason to believe that the standard deviation of the means used could we smaller, you could reduce them by half to 0.5.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_priors</span> <span class="op">&lt;-</span> <span class="va">default_priors</span><span class="op">$</span><span class="va">priors</span></span>
<span></span>
<span><span class="va">new_priors</span><span class="op">[</span> ,<span class="va">sd</span> <span class="op">:=</span> <span class="fl">0.5</span><span class="op">]</span></span></code></pre></div>
</details><p>You could then pass these new priors to the <code>epinowcast</code> function.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/epinowcast.html">epinowcast</a></span><span class="op">(</span><span class="va">pobs</span>,</span>
<span>  expectation <span class="op">=</span> <span class="va">expectation_module</span>,</span>
<span>  fit <span class="op">=</span> <span class="va">fit</span>,</span>
<span>  model <span class="op">=</span> <span class="va">multithread_model</span>,</span>
<span>  priors <span class="op">=</span> <span class="va">new_priors</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><p>Similarly, you could take an empirical Bayes approach and use the posteriors of a <a href="https://package.epinowcast.org/articles/germany-age-stratified-nowcasting.html#using-the-inflated-posterior-as-a-prior">fitted model as described in another vignette</a>.</p>
</div>
</div>
<div class="section level3">
<h3 id="exploring-your-data">Exploring your data<a class="anchor" aria-label="anchor" href="#exploring-your-data"></a>
</h3>
<p>It is important to understand the data being passed to <code>epinowcast</code> and have some ideas regarding the data-generating process for your data.
For instance, if there are significant changes in your reporting triangle, this could manifest as multi-modality in the posterior distribution (i.e., Stan is trying to fit two different reporting delays with the same parameters).
These different reporting regimes could result in long model run times, very wide posteriors, and ultimately nonsensical inferences.
Given the nuances of your data, you may need to identify and fit different regimes of your data.
These problems can also manifest over longer timescales, so while more data are generally better, too much data can result in ill-fitting models.
Sometimes it is easier to examine these features before you fit your model due to domain knowledge; however, a key component of the Bayesian Workflow is to examine your <a href="#posteriorPreds">posterior predictions</a>.</p>
</div>
<div class="section level3">
<h3 id="posterior-predictions">Posterior predictions<a class="anchor" aria-label="anchor" href="#posterior-predictions"></a>
</h3>
<p><a href="https://mc-stan.org/docs/stan-users-guide/ppcs.html" class="external-link">Posterior predictions</a>, in addition to model fitting diagnostics, provides a way to examine how well <a href="https://betanalpha.github.io/assets/case_studies/principled_bayesian_workflow.html#Step_Fourteen:_Posterior_Retrodictive_Checks65" class="external-link">your model captured your data</a>.
If your model poorly captured your data (e.g., your data points were consistently outside of the posterior credible intervals), your model will likely lead to poor inferences.
However, by examining the posterior predictions with your data, you may be able to both qualitatively and quantitatively discern if your posteriors captured your data and if there are patterns which hint at issues.
Issues in your posterior predictions without any warnings from the diagnostics could indicate that you need to examine your <a href=".settingPriors">priors</a> and your underlying data.
Utilise the <code>enw_plot_pp_quantiles</code> to examine the posterior predictive quantiles from the nowcast fits.</p>
</div>
<div class="section level3">
<h3 id="approaches-to-solve-common-problems">Approaches to solve common problems<a class="anchor" aria-label="anchor" href="#approaches-to-solve-common-problems"></a>
</h3>
<div class="section level4">
<h4 id="my-model-takes-too-long-to-run">My model takes too long to run<a class="anchor" aria-label="anchor" href="#my-model-takes-too-long-to-run"></a>
</h4>
<p>One of the more common issues with Bayesian inference is that the sampler may take a long time to run.
This can occur because the sampler is having difficulty exploring the posterior parameter space given the model and your data (i.e., the <a href="https://statmodeling.stat.columbia.edu/2021/03/25/the-folk-theorem-revisited/" class="external-link">Folk Theorem of Statistical Computing</a> “when you have computational problems, often there’s a problem with your model”).
In other words, you may have a mismatch between your data and the model you are trying to fit.
There a few simple steps to assist with this:</p>
<ol style="list-style-type: decimal">
<li>Increase the <a href=".maxTree"><code>max_treedepth</code></a> argument to 15 which will allow longer trajectories to be used for steps when sampling. This is especially important if the <code>per_at_max_treedepth</code> value is high in the returned CmdStan diagnostics.</li>
<li>Use more <a href=".settingPriors">informative priors</a>.</li>
<li>Try to simplify the model to understand potential degeneracies.</li>
<li>Reduce the amount of data you are trying to fit. This might include reducing the duration of time points over which you are trying to fit. Once you can confirm that the model will fit your data, it may just be a question of computational power when fitting larger data.</li>
<li>Head to the <a href="https://community.epinowcast.org/" class="external-link">community forum</a> and ask for some assistance.</li>
</ol>
</div>
<div class="section level4">
<h4 id="divergent-transitions">Divergent transitions<a class="anchor" aria-label="anchor" href="#divergent-transitions"></a>
</h4>
<p>CmdStan may alert you that you have <a href="https://mc-stan.org/docs/reference-manual/divergent-transitions.html" class="external-link">“divergent transitions”</a> detected during your model fit.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#&gt;1: There were 32 divergent transitions after warmup.</span></span></code></pre></div>
</details><p>A higher number of divergent transitions indicates that the model outputs are not to be trusted.
The first step in addressing this is to increase the <a href="#adaptDelta"><code>adapt_delta</code></a> argument to a numeric near one (e.g., 0.99 or 0.99).
This will allow for a smaller step size and may result in more reliable inferences.
Importantly, if the number of divergent transitions remains high, your model may be misspecified given the available data.
Regardless of if this resolves your problem, exploring divergent transitions can be a helpful way to improve your models so we don’t recommend just setting <code>adapt_delta</code> to be high without checking to see if you can improve things!
Sensible places to start are to investigate if the model parameterisation is correct for the data you have available and if your priors are reasonable.</p>
</div>
<div class="section level4">
<h4 id="my-hatrs-are-high-and-my-esss-are-low">My <span class="math inline">\(\hat{R}\)</span>s are high and my <code>ess</code>s are low<a class="anchor" aria-label="anchor" href="#my-hatrs-are-high-and-my-esss-are-low"></a>
</h4>
<p>High values of <span class="math inline">\(\hat{R}\)</span>, the Gelman-Rubin statistic used to measure convergence, indicate a lack of convergence between the different model chains.
Values greater than 1.01 to 1.05 are <a href="https://projecteuclid.org/journals/bayesian-analysis/volume-16/issue-2/Rank-Normalization-Folding-and-Localization--An-Improved-R%CB%86-for/10.1214/20-BA1221.full" class="external-link">considered unreliable</a>.
Once you have used <span class="math inline">\(\hat{R}\)</span> to assess convergence other <a href="https://discourse.mc-stan.org/t/summarising-rhat-values-over-multiple-variables-fits/23957/5" class="external-link">important measures</a> are the effective sample size and <a href="https://avehtari.github.io/rhat_ess/ess_comparison.html#Comparison_of_ESS_estimators_for_bimodal_distribution" class="external-link">MCSE</a>.
Lower values for the <a href="https://mc-stan.org/docs/reference-manual/effective-sample-size.html" class="external-link">effective sample size</a> are especially problematic.
The effective sample size provides insight into how many independent samples you have drawn from the posterior, accounting for the autocorrelation within the Markov chains.
Ideally, you want these values to be near your total number of samples passed in the <code>iter_sample</code> argument.
If <code>r_hat</code> is large and <code>ess_bulk</code>/ <code>ess_tail</code> are low, consider:</p>
<ol style="list-style-type: decimal">
<li>Increasing your <a href="#adaptDelta">adapt_delta</a> argument to a numeric value near 1 (e.g., 0.99). This will reduce the step size and could help with sampling at the risk of possible increases in runtime.</li>
<li>Use more <a href=".settingPriors">informative priors</a>.</li>
</ol>
</div>
<div class="section level4">
<h4 id="the-posterior-estimates-are-very-wide">The posterior estimates are very wide<a class="anchor" aria-label="anchor" href="#the-posterior-estimates-are-very-wide"></a>
</h4>
<p>Wide posterior values indicate that there is a high degree of uncertainty given the data and model.
If no other warnings are shown (e.g., divergent transitions, low ESS), then this result is simply the inference given the available data and prior likelihood.</p>
<p>However, Bayesian model building is often an iterative process<span class="citation"><sup>[1]</sup></span> and, in practice, it’s common to realize that that the model’s prior likelihood doesn’t accurately reflect your prior beliefs.
Priors that were thought to be non-informative can turn out to <a href="http://www.stat.columbia.edu/~gelman/research/published/entropy-19-00555-v2.pdf" class="external-link">strongly influence the posterior</a>, often in unexpected and undesirable ways.
If you suspect that this might be the case, it can make sense to revisit your priors, iteratively inspecting the joint prior model through prior predictive simulation and tweaking marginal distributions over individual parameters.
The (Stan Prior Choice wiki)[<a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations" class="external-link uri">https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations</a>] is often a useful guide to this process.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="other-resources">Other resources<a class="anchor" aria-label="anchor" href="#other-resources"></a>
</h2>
<p>Both the Epinowcast and Stan communities are pretty warm and open places and are receptive to helping others.
If you find yourself having issues with <a href="https://package.epinowcast.org">epinowcast</a>, reach out!</p>
<div class="section level3">
<h3 id="technical-issues">Technical issues<a class="anchor" aria-label="anchor" href="#technical-issues"></a>
</h3>
<ul>
<li><a href="https://community.epinowcast.org/" class="external-link">epinowcast forum</a></li>
<li><a href="https://github.com/epinowcast/epinowcast/issues" class="external-link">epinowcast issues</a></li>
<li><a href="https://discourse.mc-stan.org/" class="external-link">Stan forums</a></li>
<li><a href="https://mc-stan.org/misc/warnings.html" class="external-link">Stan guide to warnings</a></li>
</ul>
</div>
<div class="section level3">
<h3 id="learning-more-about-stan-and-bayesian-inference">Learning more about Stan and Bayesian inference<a class="anchor" aria-label="anchor" href="#learning-more-about-stan-and-bayesian-inference"></a>
</h3>
<ul>
<li><a href="https://betanalpha.github.io/writing/" class="external-link">Michael Betancourt’s case studies</a></li>
<li>Aki Vehtari <a href="https://avehtari.github.io/BDA_R_demos/demos_rstan/" class="external-link">Bayesian Data Analysis</a> and <a href="https://users.aalto.fi/~ave/casestudies.html" class="external-link">case studies</a>
</li>
</ul>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-gelmanBayesianWorkflow2020" class="csl-entry">
1. Gelman, A., Vehtari, A., Simpson, D., Margossian, C. C., Carpenter, B., Yao, Y., Kennedy, L., Gabry, J., Bürkner, P.-C., &amp; Modrák, M. (2020, November 3). <em>Bayesian <span>Workflow</span></em>. <a href="https://doi.org/10.48550/arXiv.2011.01808" class="external-link">https://doi.org/10.48550/arXiv.2011.01808</a>
</div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.samabbott.co.uk/" class="external-link">Sam Abbott</a>, Adrian Lison, Sebastian Funk, Carl Pearson, Hugo Gruson, Felix Guenther, Michael DeWitt, James Mba Azam, Jessalyn Sebastian.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
